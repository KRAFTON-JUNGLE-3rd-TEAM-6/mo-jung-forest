<!DOCTYPE html>
<html lang="ko">
<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-4bw+/aepP/YC94hEpVNVgiZdgIC5+VKNBQNGCHeKRQN+PtmoHDEXuppvnDJzQIu9" crossorigin="anonymous">
    <!-- JS -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-HwwvtgBNo3bZJJLYd8oVXjrBZt8cqVSpeBNS5n7C8IVInixGAoxmnlMuBnhbgrkm" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.1/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../static/css/index.css">
    <style>
        /* compatibility for smaller devices */
        body {
            min-width: 360px;
        }

        /* compatibility for tablet devices */
        @media (min-width: 820px) {
            .container{
                max-width: 820px;
            }
        }

        .progress {
            background-color: transparent; /* 배경 색상을 투명으로 설정 */
        }

        .profile-thumbnail {
            height: 3em; /* Adjust the height as needed */
            width: 3em; /* Ensure the width matches the height to create a square */
            border-radius: 50%; /* Create an elliptical shape (50% radius for a perfect ellipse) */
            overflow: hidden;
        }

        .profile-thumbnail img {
            object-fit: cover; /* Crop the image to fill the container */
            width: 100%; /* Ensure the image takes up the full width of the container */
            height: 100%; /* Ensure the image takes up the full height of the container */
        }

        .emoji-reaction-buttons {
            display: flex;
            justify-content: flex-end;
            margin: 10px;
        }

        .btn-emoji-reaction {
            border: none;
            background-color: #eee;
            color: #333;
            border-radius: 20px;
            padding: 2px 16px;
            margin: 0 2px;
            font-size: 20px;
            cursor: pointer;
            width: 80px;
            transition: background-color 0.3s;
            display: flex;
            align-items: center;
        }

        .btn-emoji-reaction.selected {
            background-color: #6ddead;
        }


        .emoji-count-field {
            font-size: 14px;
            flex-grow: 1;
        }

        .pagination .page-link {
            color: rgb(126, 194, 23);
        }

        .pagination .page-item.active .page-link {
            background-color: rgb(126, 194, 23);
            color: #FFF;
        }

        .btn-emoji-reaction:not(.selected):hover {
            background-color: #ddd;
        }

    </style>
    <script>
        var totalPage = 1;
        var currentPage = 1;

        $(document).ready(function () {
            // 로그인 여부와 토큰 유효성 검사
            validate_token_and_check_login();

            showMain(currentPage);
        });

        // 메세지 작성 이벤트 리스너: 실시간 글자 수 제한
        function addCharlimitEventOnMessageModal() {
            const messageInput = $('#postMessage-content');
            const charCount = $('#postMessage-charCount');
            const maxLength = 300;

            messageInput.on('input', function () {
                const currentLength = messageInput.val().length;
                charCount.text(`${currentLength}/${maxLength}`);

                if (currentLength > maxLength) {
                    charCount.addClass('text-danger');
                    messageInput.val(messageInput.val().substring(0, maxLength)); // Truncate the text
                    charCount.text(`${maxLength}/${maxLength}`);
                } else {
                    charCount.removeClass('text-danger');
                }
            });
        };

        // 메세지 작성 이벤트 리스너: submit 버튼
        function addSubmitEventOnMessageModal() {
            $('#postMessageForm').submit(function (event) {
                event.preventDefault();

                const defaultBtnText = "보내기";
                const loadingBtnText = `
                    <div class="spinner-border spinner-border-sm" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                `;
                $('#postMessage-postBtn').html(loadingBtnText);


                const msgRecipient = $('#postMessage-recipient').val();
                const msgContent = $('#postMessage-content').val();
                const formData = {
                    recipient: msgRecipient,
                    content: msgContent
                };

                $.ajax({
                    type: 'POST',
                    url: 'http://127.0.0.1:5000/messages',
                    contentType: 'application/json',
                    data: JSON.stringify(formData),
                    success: function(response) {
                        console.log('Data submitted successfully:', response);
                        $('#postMessage-recipient').val('');
                        $('#postMessage-content').val('');
                        $('#postMessage-postBtn').html(defaultBtnText);
                        $('#postMessageModal').modal('hide');
                    },
                    error: function(err) {
                        console.error('Error:', err);
                        $('#postMessage-postBtn').html(defaultBtnText);
                    }
                });
            });
        };

        // 메세지 작성 이벤트 리스너: close 버튼
        function addCloseEventOnMessageModal() {
            $('#postMessage-closeBtn').click(function () {
                $('#postMessage-recipient').val('');
                $('#postMessage-content').val('');
            });
        }

        // 투표 제안 이벤트 리스너: submit 버튼
        function addSubmitEventOnVoteModal() {
            $('#postVoteForm').submit(function (event) {
                event.preventDefault();

                const defaultBtnText = "투표 제안";
                const loadingBtnText = `
                    <div class="spinner-border spinner-border-sm" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                `;
                $('#postVote-postBtn').html(loadingBtnText);

                const voteTitle = $('#postVote-title').val();
                const voteOptions = [];
                $('[id^="postVote-option"]').each((index, element) => {
                    voteOptions.push({
                        optionId: index,
                        content: element.value
                    });
                })
                var formData = {
                    title: voteTitle,
                    option: voteOptions
                };

                $.ajax({
                    type: 'POST',
                    url: 'http://127.0.0.1:5000/votes',
                    contentType: 'application/json',
                    data: JSON.stringify(formData),
                    success: function(response) {
                        console.log('Data submitted successfully:', response);
                        $('#postVote-title').val('');
                        $('[id^="postVote-option"]').each((index, element) => {
                            element.value = '';
                        });
                        $('#postVote-postBtn').html(defaultBtnText);
                        $('#postVoteModal').modal('hide');
                    },
                    error: function(err) {
                        console.error('Error:', err);
                        $('#postVote-postBtn').html(defaultBtnText);
                    }
                });
            });

        };

        // 투표 제안 이벤트 리스너: close 버튼
        function addCloseEventOnVoteModal() {
            $('#postVote-closeBtn').click(function () {
                $('#postVote-title').val('');
                $('[id^="postVote-option"]').each((index, element) => {
                    element.value = '';
                });
            });
        }

        async function showMain(pageNum){
            await $.ajax({
                    type: "GET",
                    url: "/mainBoard?page=" + pageNum,
                    data: {},
                    success: function (response) {
                        // HTTP 통신 성공이지만 메세지가 success가 아닌 경우 (드물 것으로 예상)
                        if (response.result !== "success")
                        return;

                        $("#feed-box").empty();

                        for (const post of response.data) {
                            console.dir(post);
                            if (post.mode == "MESSAGE"){
                                makeMessageCard(post.postId, post.recipient, post.content);
                                updateCardWithEmotion(post.postId);
                            }
                            else if (post.mode == "VOTE") {
                                if (!post.hasOwnProperty('selectedOptionId')) {
                                    makeBeforeVoteCard(post.postId, post.title, post.options);
                                    updateCardWithEmotion(post.postId);
                                } else {
                                    makeAfterVoteCard(post.postId, post.title, post.options,post.optionProportions, post.selectedOptionId);
                                    updateCardWithEmotion(post.postId);
                                }
                            }
                        }

                        // 선택된 페이지 (defalut : 1)
                        totalPage = response['totalPage'];
                        currentPage = response['page'];

                        makePagiNation(totalPage,pageNum);

                        },
                    error: function (error) {
                        console.log(error);
                    }
                });

            addCharlimitEventOnMessageModal();
            addSubmitEventOnMessageModal();
            addCloseEventOnMessageModal();
            addSubmitEventOnVoteModal();
            addCloseEventOnVoteModal();
            addPageEventListener();
        }

        function makeMessageCard(postId, recipient, content) {
            const tempHtml = `
            <div id="${postId}" class="card mb-3 shadow-lg bg-light" style="height: 216.45px;">
                <div class="card-header">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-chat-right-dots-fill" viewBox="0 0 16 16">
                        <path d="M16 2a2 2 0 0 0-2-2H2a2 2 0 0 0-2 2v8a2 2 0 0 0 2 2h9.586a1 1 0 0 1 .707.293l2.853 2.853a.5.5 0 0 0 .854-.353V2zM5 6a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm4 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm3 1a1 1 0 1 1 0-2 1 1 0 0 1 0 2z"/>
                    </svg>
                    익명의 사용자가 <b>${recipient}</b>에게 메세지를 남겼습니다
                </div>
                <div class="card-body d-flex flex-column justify-content-center">
                    ${content}
                </div>
                <div class="emoji-reaction-buttons">
                    <button class="btn btn-emoji-reaction" value="0" onclick="react('${postId}', 0); updateCardWithEmotion('${postId}');">
                        <div class="emoji-btn-field">❤️</div>
                        <div class="emoji-count-field">0</div>
                    </button>
                    <button class="btn btn-emoji-reaction" value="1" onclick="react('${postId}', 1); updateCardWithEmotion('${postId}');">
                        <div class="emoji-btn-field">🤣</div>
                        <div class="emoji-count-field">0</div>
                    </button>
                    <button class="btn btn-emoji-reaction" value="2" onclick="react('${postId}', 2); updateCardWithEmotion('${postId}');">
                        <div class="emoji-btn-field">😪</div>
                        <div class="emoji-count-field">0</div>
                    </button>
                    <button class="btn btn-emoji-reaction" value="3" onclick="react('${postId}', 3); updateCardWithEmotion('${postId}');">
                        <div class="emoji-btn-field">💢</div>
                        <div class="emoji-count-field">0</div>
                    </button>
                    <button class="btn btn-emoji-reaction" value="4" onclick="react('${postId}', 4); updateCardWithEmotion('${postId}');">
                        <div class="emoji-btn-field">🔥</div>
                        <div class="emoji-count-field">0</div>
                    </button>
                    <button class="btn btn-emoji-reaction" value="5" onclick="react('${postId}', 5); updateCardWithEmotion('${postId}');">
                        <div class="emoji-btn-field">❓</div>
                        <div class="emoji-count-field">0</div>
                    </button>
                </div>
            </div>`;
            $("#feed-box").append(tempHtml);
        }

        // 투표 온클릭 이벤트
        function vote(postId, optionId) {
            if (confirm('정말 투표하시겠습니까?')) {
                $.ajax({
                    type: 'POST',
                    url: `/votes/${postId}/options/${optionId}`,
                    contentType: 'application/json',
                    // data: JSON.stringify(formData),
                    success: function(response) {
                        console.log('Data submitted successfully:', response);
                        showMain(currentPage);
                    },
                    error: function(err) {
                        console.error('Error:', err);
                    }
                });
            } else {
                $('input[type=radio][name=voteOption]').prop('checked', false);
            }
        }

        function makeBeforeVoteCard(postId, title, options){
            let tempHtml = `
            <div id="${postId}" class="card mb-3 shadow-lg bg-light" style="height: 216.45px;">
                <div class="card-header">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-mailbox2-flag" viewBox="0 0 16 16">
                        <path d="M10.5 8.5V3.707l.854-.853A.5.5 0 0 0 11.5 2.5v-2A.5.5 0 0 0 11 0H9.5a.5.5 0 0 0-.5.5v8h1.5Z"/>
                        <path d="M4 3h4v1H6.646A3.99 3.99 0 0 1 8 7v6h7V7a3 3 0 0 0-3-3V3a4 4 0 0 1 4 4v6a1 1 0 0 1-1 1H1a1 1 0 0 1-1-1V7a4 4 0 0 1 4-4Zm.585 4.157C4.836 7.264 5 7.334 5 7a1 1 0 0 0-2 0c0 .334.164.264.415.157C3.58 7.087 3.782 7 4 7c.218 0 .42.086.585.157Z"/>
                    </svg>
                    익명의 사용자가 투표를 남겼습니다: <b>"${title}"</b>
                </div>
                <div class="card-body d-flex flex-column justify-content-center">`;

            options.forEach((e, i) => {
                tempHtml += `
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="voteOption" onclick="vote('${postId}', '${e.optionId}')">
                        <label class="form-check-label">
                            ${e.content}
                        </label>
                    </div>`;
            });
            tempHtml += `
                </div>
                <div class="emoji-reaction-buttons">
                    <button class="btn btn-emoji-reaction" value="0" onclick="react('${postId}', 0); updateCardWithEmotion('${postId}');">
                        <div class="emoji-btn-field">❤️</div>
                        <div class="emoji-count-field">0</div>
                    </button>
                    <button class="btn btn-emoji-reaction" value="1" onclick="react('${postId}', 1); updateCardWithEmotion('${postId}');">
                        <div class="emoji-btn-field">🤣</div>
                        <div class="emoji-count-field">0</div>
                    </button>
                    <button class="btn btn-emoji-reaction" value="2" onclick="react('${postId}', 2); updateCardWithEmotion('${postId}');">
                        <div class="emoji-btn-field">😪</div>
                        <div class="emoji-count-field">0</div>
                    </button>
                    <button class="btn btn-emoji-reaction" value="3" onclick="react('${postId}', 3); updateCardWithEmotion('${postId}');">
                        <div class="emoji-btn-field">💢</div>
                        <div class="emoji-count-field">0</div>
                    </button>
                    <button class="btn btn-emoji-reaction" value="4" onclick="react('${postId}', 4); updateCardWithEmotion('${postId}');">
                        <div class="emoji-btn-field">🔥</div>
                        <div class="emoji-count-field">0</div>
                    </button>
                    <button class="btn btn-emoji-reaction" value="5" onclick="react('${postId}', 5); updateCardWithEmotion('${postId}');">
                        <div class="emoji-btn-field">❓</div>
                        <div class="emoji-count-field">0</div>
                    </button>
                </div>
            </div>`;
            $("#feed-box").append(tempHtml);
        }

        function makeAfterVoteCard(postId, title, options, optionProportions, selectedOptionId){
            let tempHtml = `<div id=${postId} class="card mb-3 shadow-lg bg-light" style="height: 216.45px;">
            <div class="card-header">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-mailbox2" viewBox="0 0 16 16">
                    <path d="M9 8.5h2.793l.853.854A.5.5 0 0 0 13 9.5h1a.5.5 0 0 0 .5-.5V8a.5.5 0 0 0-.5-.5H9v1z"/>
                    <path d="M12 3H4a4 4 0 0 0-4 4v6a1 1 0 0 0 1 1h14a1 1 0 0 0 1-1V7a4 4 0 0 0-4-4zM8 7a3.99 3.99 0 0 0-1.354-3H12a3 3 0 0 1 3 3v6H8V7zm-3.415.157C4.42 7.087 4.218 7 4 7c-.218 0-.42.086-.585.157C3.164 7.264 3 7.334 3 7a1 1 0 0 1 2 0c0 .334-.164.264-.415.157z"/>
                </svg>
                이미 투표하셨습니다: <b>"${title}"</b>
            </div>
            <div class="card-body d-flex flex-column justify-content-center">`;

            let optionsMap = {};
            for (let option of options) {
                optionsMap[option.optionId] = option;
            }

            let propertionMap = Object.assign({}, ...optionProportions);

            let result = [];
            let max = 0;
            for (let key in optionsMap) {
                let newObject = {};
                newObject[optionsMap[key].content] = propertionMap[key] || 0;
                if(newObject[optionsMap[key].content] > max)
                {
                    max = newObject[optionsMap[key].content];
                }

                result.push(newObject);
            }

            console.dir(result);
            console.log(max);

            console.log(selectedOptionId);

            for(let obj in result){
                let objValue =result[obj][optionsMap[obj].content];
                let rate = objValue / max * 100;
                let tooltipTitle = ""
                console.log(obj);

                if (selectedOptionId == obj) {
                    tooltipTitle = "내가 선택한 답변"
                }

                var subHtml = ""
                if(rate == 0)  {
                    subHtml = `<div id="vote-option" style="display: flex; align-items: center; position: relative;width: 70%;">
                        <div class="text-muted" style="min-width: 100px;">${optionsMap[obj].content}</div>
                        <div class="progress" style="flex-grow: 1;">
                            <div class="progress-bar bg-success" role="progressbar" style="width: ${5}%;" aria-valuenow="${rate}" aria-valuemin="0" aria-valuemax="100" 
                            style="color: black;"></div><span style="margin-left:20px;color: black;">0표</span>
                        </div>
                        </div>`;
                } else {
                    if(tooltipTitle == "") {
                        subHtml =`<div id="vote-option" style="display: flex; align-items: center; position: relative;width: 70%;">
                    <div class="text-muted" style="min-width: 100px;">${optionsMap[obj].content}</div>
                    <div class="progress" style="flex-grow: 1">
                        <div class="progress-bar bg-success" role="progressbar" style="width: ${rate}%;" aria-valuenow="${rate}" aria-valuemin="0" aria-valuemax="100" 
                        >${objValue}표</div>
                    </div>
                </div>`;
                    } else {
                        subHtml =`<div id="vote-option" style="display: flex; align-items: center; position: relative;width: 70%;">
                    <div class="text-muted" style="min-width: 100px;">${optionsMap[obj].content}</div>
                    <div class="progress" style="flex-grow: 1;">
                        <div class="progress-bar bg-success" role="progressbar" style="width: ${rate}%;" aria-valuenow="${rate}" aria-valuemin="0" aria-valuemax="100" 
                        >${objValue}표</div>
                    </div>
                    <span style="width: 200px;height: 25px;background: #05D282;position: absolute;right: -220px;color:#fff;border-radius:25px;text-align: center;">${tooltipTitle}</span>
                </div>`;
                    }
                    
                }

                tempHtml += subHtml;
            }

            tempHtml += `
                <div class="emoji-reaction-buttons">
                    <button class="btn btn-emoji-reaction" value="0" onclick="react('${postId}', 0); updateCardWithEmotion('${postId}');">
                        <div class="emoji-btn-field">❤️</div>
                        <div class="emoji-count-field">0</div>
                    </button>
                    <button class="btn btn-emoji-reaction" value="1" onclick="react('${postId}', 1); updateCardWithEmotion('${postId}');">
                        <div class="emoji-btn-field">🤣</div>
                        <div class="emoji-count-field">0</div>
                    </button>
                    <button class="btn btn-emoji-reaction" value="2" onclick="react('${postId}', 2); updateCardWithEmotion('${postId}');">
                        <div class="emoji-btn-field">😪</div>
                        <div class="emoji-count-field">0</div>
                    </button>
                    <button class="btn btn-emoji-reaction" value="3" onclick="react('${postId}', 3); updateCardWithEmotion('${postId}');">
                        <div class="emoji-btn-field">💢</div>
                        <div class="emoji-count-field">0</div>
                    </button>
                    <button class="btn btn-emoji-reaction" value="4" onclick="react('${postId}', 4); updateCardWithEmotion('${postId}');">
                        <div class="emoji-btn-field">🔥</div>
                        <div class="emoji-count-field">0</div>
                    </button>
                    <button class="btn btn-emoji-reaction" value="5" onclick="react('${postId}', 5); updateCardWithEmotion('${postId}');">
                        <div class="emoji-btn-field">❓</div>
                        <div class="emoji-count-field">0</div>
                    </button>
                </div>
            </div>`;
            $("#feed-box").append(tempHtml);
        }

        function react(postId, emojiId) {
            const requestEmojiId = parseInt(emojiId);
            const storedEmote = getEmotion(postId);

            // 반응 이력이 없는 경우 => POST
            if (!storedEmote) {
                postEmotion(postId, requestEmojiId);
                // updateCardWithEmotion(postId);
                return;
            }
            // 반응 이력이 있는 경우
            // (1) 요청 반응과 저장 반응이 같다면 취소 요청 => DELETE
            const storedEmojiId = storedEmote.emojiId;
            if (requestEmojiId === storedEmojiId) {
                deleteEmotion(postId, requestEmojiId);
                // updateCardWithEmotion(postId);
                return;
            }
            // (2) 요청 반응과 저장 반응이 다르다면 업데이트 요청 => DELETE and POST
            deleteEmotion(postId, storedEmojiId);
            postEmotion(postId, requestEmojiId);
            // updateCardWithEmotion(postId);
        }

        function getEmotion(postId) {
            let res;
            $.ajax({
                type: 'GET',
                url: '/reactions/' + postId,
                contentType: 'application/json',
                async: false,
                success: function(response) {
                    console.log('Data submitted successfully:', response);
                    res = response.storedEmote;
                },
                error: function(err) {
                    console.error('Error:', err);
                }
            })
            return res;
        }

        async function postEmotion(postId, emojiId) {
            $.ajax({
                type: 'POST',
                url: '/reactions',
                contentType: 'application/json',
                async: false,
                data: JSON.stringify({
                    postId: postId,
                    emojiId: emojiId
                }),
                success: function(response) {
                    console.log('Data submitted successfully:', response);
                },
                error: function(err) {
                    console.error('Error:', err);
                }
            })
        }

        async function deleteEmotion(postId, emojiId) {
            $.ajax({
                type: 'DELETE',
                url: '/reactions',
                contentType: 'application/json',
                async: false,
                data: JSON.stringify({
                    postId: postId,
                    emojiId: emojiId
                }),
                async: false,
                success: function(response) {
                    console.log('Data submitted successfully:', response);
                },
                error: function(err) {
                    console.error('Error:', err);
                }
            })
        }

        async function updateCardWithEmotion(postId) {
            await $.ajax({
                type: 'GET',
                url: '/allreactions/' + postId,
                contentType: 'application/json',
                success: function(response) {                    
                    const emotes = response.storedEmotes;
                    
                    const zeroToFive = Array.from(Array(6).keys());
                    for (const figure of zeroToFive) {
                        const oldCount = $(`#${postId} .btn-emoji-reaction[value=${figure}] .emoji-count-field`).text();
                        const newCount = emotes.filter(emote => emote.emojiId === figure).length;
                        $(`#${postId} .btn-emoji-reaction[value=${figure}] .emoji-count-field`).text(newCount);
                        // console.log(`figuring ${figure}... ${oldCount} => ${newCount}`)
                    };

                    $(`#${postId} .btn-emoji-reaction`).removeClass('selected');
                    $(`#${postId} .btn-emoji-reaction[value=${response.selectedEmojiId}]`).addClass('selected');

                },
                error: function(err) {
                    console.error('Error:', err);
                }
            })
        }

        function addPageEventListener(){
                $('#pagination-box .page-link').on('click', function(event) {
                const page = $(this).data('page');
                event.preventDefault();

                $('#pagination-box .page-item').removeClass('active');
                $(this).parent().addClass('active');
                
                if (page) {
                    showMain(page);
                }
            });

            const pagiNationMaxNum = 5;

            // '이전' 버튼을 눌렀을 때
            $('#pagination-box .page-link-previous').on('click', function (event) {
                event.preventDefault();
                if (currentPage > pagiNationMaxNum) {
                    makePagiNation(currentPage - pagiNationMaxNum);
                }
            });

            // '다음' 버튼을 눌렀을 때
            $('#pagination-box .page-link-next').on('click', function (event) {
                event.preventDefault();
                if (currentPage + pagiNationMaxNum <= totalPage) {
                    makePagiNation(currentPage + pagiNationMaxNum);
                }
            });

        }

        function makePagiNation(totalPage,pageNum){
            const pagiNationMaxNum = 5;
            let pageStart = Math.max(1, pageNum - pagiNationMaxNum);
            let pageEnd = Math.min(totalPage, pageNum + pagiNationMaxNum - 1);

            if(pageEnd > totalPage){
                pageEnd = totalPage;
            }

            $("#pagination-box").empty();

            let tempHtml = `<ul class="pagination">`;

            if (pageStart > pagiNationMaxNum) {
            tempHtml += `<li class="page-item">
                    <a class="page-link" href="#" aria-label="Previous">
                        <span aria-hidden="true">&laquo;</span>
                        <span class="sr-only">이전</span>
                    </a>
                </li>`;
            }
            
            for(let i = pageStart; i <= pageEnd;i++){
                let subHtml =`<li class="page-item">
                    <a class="page-link" href="#" data-page="${i}">${i}</a>
                    </li>`;

                    if (i === pageNum) {
                        subHtml = subHtml.replace('<li class="page-item">', '<li class="page-item active">');
                    }
                tempHtml += subHtml;
            }

            if (pageEnd < totalPage) {
            tempHtml += `<li class="page-item">
                    <a class="page-link" href="#" aria-label="Next">
                        <span aria-hidden="true">&raquo;</span>
                        <span class="sr-only">다음</span>
                    </a>
                </li>`;
            }

            tempHtml += `</ul>`;

            $("#pagination-box").append(tempHtml);
        }
        
        function validate_token_and_check_login() {
            $.ajax({
                        type: "GET",
                        url: "/auth/check",
                        contentType: "application/json; charset=utf-8",
                        success: function(response) {
                            if (response['result'] == 'success') {
                                // 그대로 있는다.
                            } else if(response['result'] == 'afail') {  // 'afail'인 경우, 액세스 토큰 재갱신 의사를 물어봄
                                if(confirm("로그인 유지 시간이 만료되었습니다. 연장하시겠습니까?") == true) {
                                    $.ajax({
                                        type: "GET",
                                        url: "/auth/refresh",
                                        contentType: "application/json; charset=utf-8",
                                        success: function(response) {
                                            if (response['result'] == 'success') {  // 연장에 성공한 경우
                                                alert('연장되었습니다.');
                                            } else {  // 'fail'인 경우, 가이드 메시지
                                                alert(response['data']);
                                            }
                                        }, error: function(error) {
                                            alert(error);
                                        }
                                    })
                                } else { // 토큰 갱신을 원하지 않으면, 로그아웃 처리
                                    $.ajax({
                                        type: "GET",
                                        url: "/users/logout",
                                        contentType: "application/json; charset=utf-8",
                                        success: function(response) {
                                            if (response['result'] == 'success') {
                                                alert('로그아웃 되었습니다.');
                                                $(location).attr('href', "{{ url_for('home') }}");
                                            } else {  // 'fail'인 경우, 가이드 메시지
                                                alert(response['data']);
                                            }

                                        }, error: function(error) {
                                            alert(error);
                                        }
                                    })
                                }
                            } else if(response['result'] == 'rfail') { // 'rfail'인 경우, 로그아웃 처리
                            $.ajax({
                                        type: "GET",
                                        url: "/users/logout",
                                        contentType: "application/json; charset=utf-8",
                                        success: function(response) {
                                            if (response['result'] == 'success') {
                                                alert('로그아웃 되었습니다.');
                                                $(location).attr('href', "{{ url_for('home') }}");
                                            } else {  // 'fail'인 경우, 가이드 메시지
                                                alert(response['data']);
                                            }

                                        }, error: function(error) {
                                            alert(error);
                                        }
                                    })
                            } else {
                                $(location).attr('href', "{{ url_for('home') }}");
                            }
                        }, error: function(error) {
                            alert(error);
                        }
                    })
        }
    </script>
</head>
<body>
    <!-- top container -->
    <div id="mypage-box" class="container">
        <div class="d-flex justify-content-end">
            <i class="bi bi-person-square" style="font-size: 19px;margin-top: 7px;margin-right: 10px;"></i>

            <span id="user-name-header" class="mt-2 text-muted">{{ userName }}</span>
            <span  class="mt-2 text-muted">님 안녕하세요</span>
        </div>
    </div>

    <!-- feed container -->
    <div id="feed-title" class="container d-flex justify-content-end pt-4 pb-2">
        <h1 id="board-title-big" class="text-success col-9">모정숲 피드</h1>
        <div>
            <button type="button" class="btn btn-outline-success" data-bs-toggle="modal" data-bs-target="#postMessageModal">메세지 작성</button>
            <button type="button" class="btn btn-outline-success" data-bs-toggle="modal" data-bs-target="#postVoteModal">투표 제안</button>
        </div>
    </div>
    </div>
    <div id="feed-box" class="container">
        <!-- 개발용 카드 1: 메세지 -->
        <div class="card mb-3 shadow-lg bg-light" style="height: 216.45px;">
            <div class="card-header">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-chat-right-dots-fill" viewBox="0 0 16 16">
                    <path d="M16 2a2 2 0 0 0-2-2H2a2 2 0 0 0-2 2v8a2 2 0 0 0 2 2h9.586a1 1 0 0 1 .707.293l2.853 2.853a.5.5 0 0 0 .854-.353V2zM5 6a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm4 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm3 1a1 1 0 1 1 0-2 1 1 0 0 1 0 2z"/>
                </svg>
                익명의 사용자가 <b>김상우</b>에게 메세지를 남겼습니다
            </div>
            <div class="card-body d-flex flex-column justify-content-center">
                잘생겼어요
            </div>
            <div class="emoji-reaction-buttons">
                <button class="btn btn-emoji-reaction" value="0" onclick="react('65274b3280920e306bdc1145', 0)">
                    <div class="emoji-btn-field">❤️</div>
                    <div class="emoji-count-field">0</div>
                </button>
                <button class="btn btn-emoji-reaction" value="1" onclick="react('65274b3280920e306bdc1145', 1)">
                    <div class="emoji-btn-field">🤣</div>
                    <div class="emoji-count-field">0</div>
                </button>
                <button class="btn btn-emoji-reaction" value="2" onclick="react('65274b3280920e306bdc1145', 2)">
                    <div class="emoji-btn-field">😪</div>
                    <div class="emoji-count-field">0</div>
                </button>
                <button class="btn btn-emoji-reaction" value="3" onclick="react('65274b3280920e306bdc1145', 3)">
                    <div class="emoji-btn-field">💢</div>
                    <div class="emoji-count-field">0</div>
                </button>
                <button class="btn btn-emoji-reaction" value="4" onclick="react('65274b3280920e306bdc1145', 4)">
                    <div class="emoji-btn-field">🔥</div>
                    <div class="emoji-count-field">0</div>
                </button>
                <button class="btn btn-emoji-reaction" value="5" onclick="react('65274b3280920e306bdc1145', 5)">
                    <div class="emoji-btn-field">❓</div>
                    <div class="emoji-count-field">0</div>
                </button>
            </div>
        </div>
        <!-- 개발용 카드 2: 투표 전 -->
        <div class="card mb-3 shadow-lg bg-light" style="height: 216.45px;">
            <div class="card-header">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-mailbox2-flag" viewBox="0 0 16 16">
                    <path d="M10.5 8.5V3.707l.854-.853A.5.5 0 0 0 11.5 2.5v-2A.5.5 0 0 0 11 0H9.5a.5.5 0 0 0-.5.5v8h1.5Z"/>
                    <path d="M4 3h4v1H6.646A3.99 3.99 0 0 1 8 7v6h7V7a3 3 0 0 0-3-3V3a4 4 0 0 1 4 4v6a1 1 0 0 1-1 1H1a1 1 0 0 1-1-1V7a4 4 0 0 1 4-4Zm.585 4.157C4.836 7.264 5 7.334 5 7a1 1 0 0 0-2 0c0 .334.164.264.415.157C3.58 7.087 3.782 7 4 7c.218 0 .42.086.585.157Z"/>
                </svg>
                익명의 사용자가 투표를 남겼습니다: <b>"탕후루vs탕수육"</b>
            </div>
            <div class="card-body d-flex flex-column justify-content-center">
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="voteOption" value="0">
                    <label class="form-check-label">
                        탕후루
                    </label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="voteOption" value="1">
                    <label class="form-check-label">
                        탕수육
                    </label>
                </div>
            </div>
            <div class="emoji-reaction-buttons">
                <button class="btn btn-emoji-reaction">
                    <div class="emoji-btn-field">❤️</div>
                    <div class="emoji-count-field">0</div>
                </button>
                <button class="btn btn-emoji-reaction">
                    <div class="emoji-btn-field">🤣</div>
                    <div class="emoji-count-field">0</div>
                </button>
                <button class="btn btn-emoji-reaction">
                    <div class="emoji-btn-field">😪</div>
                    <div class="emoji-count-field">0</div>
                </button>
                <button class="btn btn-emoji-reaction">
                    <div class="emoji-btn-field">💢</div>
                    <div class="emoji-count-field">0</div>
                </button>
                <button class="btn btn-emoji-reaction">
                    <div class="emoji-btn-field">🔥</div>
                    <div class="emoji-count-field">0</div>
                </button>
                <button class="btn btn-emoji-reaction">
                    <div class="emoji-btn-field">❓</div>
                    <div class="emoji-count-field">0</div>
                </button>
            </div>
        </div>
        <!-- 개발용 카드 3: 투표 후 -->
        <div class="card mb-3 shadow-lg bg-light" style="height: 216.45px;">
            <div class="card-header text-muted">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-mailbox2" viewBox="0 0 16 16">
                    <path d="M9 8.5h2.793l.853.854A.5.5 0 0 0 13 9.5h1a.5.5 0 0 0 .5-.5V8a.5.5 0 0 0-.5-.5H9v1z"/>
                    <path d="M12 3H4a4 4 0 0 0-4 4v6a1 1 0 0 0 1 1h14a1 1 0 0 0 1-1V7a4 4 0 0 0-4-4zM8 7a3.99 3.99 0 0 0-1.354-3H12a3 3 0 0 1 3 3v6H8V7zm-3.415.157C4.42 7.087 4.218 7 4 7c-.218 0-.42.086-.585.157C3.164 7.264 3 7.334 3 7a1 1 0 0 1 2 0c0 .334-.164.264-.415.157z"/>
                </svg>
                이미 투표하셨습니다: <b>"탕후루vs탕수육"</b>
            </div>
            <div class="card-body d-flex flex-column justify-content-center">
                <div>
                    <div class="text-muted">탕후루</div>
                    <div class="progress">
                        <div class="progress-bar bg-success" role="progressbar" style="width: 25%;" aria-valuenow="{{ 25 }}" aria-valuemin="0" aria-valuemax="100">1표</div>
                    </div>
                </div>
                <div>
                    <div class="text-muted">탕수육</div>
                    <div class="progress">
                        <div class="progress-bar bg-success" role="progressbar" style="width: 25%;" aria-valuenow="{{ 25 }}" aria-valuemin="0" aria-valuemax="100">1표</div>
                    </div>
                </div>
            </div>
            <div class="emoji-reaction-buttons">
                <button class="btn btn-emoji-reaction">
                    <div class="emoji-btn-field">❤️</div>
                    <div class="emoji-count-field">0</div>
                </button>
                <button class="btn btn-emoji-reaction">
                    <div class="emoji-btn-field">🤣</div>
                    <div class="emoji-count-field">0</div>
                </button>
                <button class="btn btn-emoji-reaction">
                    <div class="emoji-btn-field">😪</div>
                    <div class="emoji-count-field">0</div>
                </button>
                <button class="btn btn-emoji-reaction">
                    <div class="emoji-btn-field">💢</div>
                    <div class="emoji-count-field">0</div>
                </button>
                <button class="btn btn-emoji-reaction">
                    <div class="emoji-btn-field">🔥</div>
                    <div class="emoji-count-field">0</div>
                </button>
                <button class="btn btn-emoji-reaction">
                    <div class="emoji-btn-field">❓</div>
                    <div class="emoji-count-field">0</div>
                </button>
            </div>
        </div>
    </div>

    <!-- pagination container -->
    <div id="pagination-box" class="container">
        <h1>페이지네이션 예제</h1>
        <ul class="pagination">
            {#
            <li class="page-item"><a class="page-link" href="{{ url_for('index', page=1) }}">이전</a></li>
            {% for page_num in range(1, 5) %}
            <li class="page-item {% if page_num == current_page %}active{% endif %}">
                <a class="page-link" href="{{ url_for('index', page=page_num) }}">{{ page_num }}</a>
            </li>
            {% endfor %}
            <li class="page-item"><a class="page-link" href="{{ url_for('index', page=total_pages) }}">다음</a></li>
            #}
        </ul>
    </div>

    <!-- Hidden Modals -->
    <!-- 메세지 작성 모달 창 -->
    <div class="modal fade" id="postMessageModal" tabindex="-1" aria-labelledby="postMessageModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <form id="postMessageForm">
                    <div class="modal-body">
                        <div class="d-flex align-items-center mb-1">
                            <div class="postMessage-iconField">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-envelope text-success" viewBox="0 0 16 16">
                                    <path d="M0 4a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V4Zm2-1a1 1 0 0 0-1 1v.217l7 4.2 7-4.2V4a1 1 0 0 0-1-1H2Zm13 2.383-4.708 2.825L15 11.105V5.383Zm-.034 6.876-5.64-3.471L8 9.583l-1.326-.795-5.64 3.47A1 1 0 0 0 2 13h12a1 1 0 0 0 .966-.741ZM1 11.105l4.708-2.897L1 5.383v5.722Z" />
                                </svg>
                                받는 사람:
                            </div>
                            <div class="postMessage-recipientField">
                                <input type="text" id="postMessage-recipient" class="form-control border-0" placeholder="받는 사람을 입력하세요" required>
                            </div>
                        </div>
                        <div class="postMessage-contentField">
                            <textarea class="form-control" id="postMessage-content" placeholder="메세지를 입력하세요" rows="6" required></textarea>
                            <div id="postMessage-charCount" class="text-end">0/300</div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" id="postMessage-closeBtn" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                        <button type="submit" id="postMessage-postBtn" class="btn btn-success">보내기</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <!-- 투표 제안 모달 창 -->
    <div class="modal fade" id="postVoteModal" tabindex="-1" aria-labelledby="postVoteModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <form id="postVoteForm">
                    <div class="modal-body">
                        <div class="d-flex align-items-center mb-1">
                            <div class="postVote-iconField">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-ui-checks text-success" viewBox="0 0 16 16">
                                    <path d="M7 2.5a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-7a.5.5 0 0 1-.5-.5v-1zM2 1a2 2 0 0 0-2 2v2a2 2 0 0 0 2 2h2a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2H2zm0 8a2 2 0 0 0-2 2v2a2 2 0 0 0 2 2h2a2 2 0 0 0 2-2v-2a2 2 0 0 0-2-2H2zm.854-3.646a.5.5 0 0 1-.708 0l-1-1a.5.5 0 1 1 .708-.708l.646.647 1.646-1.647a.5.5 0 1 1 .708.708l-2 2zm0 8a.5.5 0 0 1-.708 0l-1-1a.5.5 0 0 1 .708-.708l.646.647 1.646-1.647a.5.5 0 0 1 .708.708l-2 2zM7 10.5a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-7a.5.5 0 0 1-.5-.5v-1zm0-5a.5.5 0 0 1 .5-.5h5a.5.5 0 0 1 0 1h-5a.5.5 0 0 1-.5-.5zm0 8a.5.5 0 0 1 .5-.5h5a.5.5 0 0 1 0 1h-5a.5.5 0 0 1-.5-.5z" />
                                </svg>
                                투표 주제:
                            </div>
                            <div class="postVote-titleField">
                                <input type="text" id="postVote-title" class="form-control border-0" placeholder="주제를 입력하세요" required>
                            </div>
                        </div>
                        <div class="postVote-optionField">
                            <input type="text" id="postVote-option1" class="form-control mb-1" placeholder="1안" required>
                            <input type="text" id="postVote-option2" class="form-control mb-1" placeholder="2안" required>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" id="postVote-closeBtn" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                        <button type="submit" id="postVote-postBtn" class="btn btn-success">투표 제안</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

</body>
</html>